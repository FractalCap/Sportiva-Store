<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Producto - Sportiva Store</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Impact&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Elemento del cursor personalizado -->
    <div id="custom-cursor"></div>

    <header class="header">
        <nav class="header-nav">
             <ul class="nav-links">
                <li><a href="index.html#women-catalog">Tienda</a></li>
                <li class="has-dropdown">
                    <a href="index.html#women-catalog">Mujeres</a>
                    <ul class="dropdown">
                        <li class="has-dropdown">
                            <a href="#">Shorts ▸</a>
                            <ul class="dropdown dropdown-submenu">
                                <li><a href="productos.html?product=short-tradicional">Short Tradicional</a></li>
                                <li><a href="productos.html?product=short-tie-dye">Short Tie Dye</a></li>
                            </ul>
                        </li>
                        <li class="has-dropdown">
                            <a href="#">Yoga ▸</a>
                             <ul class="dropdown dropdown-submenu">
                                <li><a href="productos.html?product=yoga-jacket-lineas">Yoga Jacket Lineas</a></li>
                                <li><a href="productos.html?product=yoga-jacket-clasica">Yoga Jacket Clasica</a></li>
                                <li><a href="#">Yoga Jacket Tradicional</a></li>
                            </ul>
                        </li>
                         <li class="has-dropdown">
                            <a href="#">Tops ▸</a>
                             <ul class="dropdown dropdown-submenu">
                                <li><a href="productos.html?product=top-cruzado">Top cruzado</a></li>
                                <li><a href="productos.html?product=top-3-tiras">Top 3 Tiras</a></li>
                                <li><a href="productos.html?product=top-cruzado-b2">Top cruzado B2</a></li>
                                <li><a href="productos.html?product=top-bea">Top Bea</a></li>
                                <li><a href="productos.html?product=top-sencillo">Top Sencillo</a></li>
                                <li><a href="productos.html?product=top-un-hombro">Top Un Hombro</a></li>
                                <li><a href="productos.html?product=top-gota">Top Gota</a></li>
                                <li><a href="productos.html?product=top-kiss">Top Kiss</a></li>
                                <li><a href="productos.html?product=top-fruncido">Top Fruncido</a></li>
                                <li><a href="productos.html?product=top-convencional">Top Convencional</a></li>
                            </ul>
                        </li>
                        <li class="has-dropdown">
                            <a href="#">Leggins ▸</a>
                             <ul class="dropdown dropdown-submenu">
                                <li><a href="productos.html?product=leggings-unicolor-push-up">Leggins Unicolor</a></li>
                            </ul>
                        </li>
                         <li class="has-dropdown">
                            <a href="#">Enterizos ▸</a>
                             <ul class="dropdown dropdown-submenu">
                                <li><a href="productos.html?product=enterizos">Ver Colección</a></li>
                            </ul>
                        </li>
                        <li><a href="productos.html?product=pantalon-bota-campana">Pant bota campana</a></li>
                        <li><a href="productos.html?product=conjunto-premium">Conjunto Premium</a></li>
                        <li><a href="productos.html?product=conjunto-rib">Conjunto Rib</a></li>
                        <li><a href="productos.html?product=blusa-compresiva">Blusa Compresiva</a></li>
                    </ul>
                </li>
                <li class="has-dropdown">
                    <a href="index.html#men-catalog">Hombres</a>
                     <ul class="dropdown">
                        <li><a href="productos.html?product=chaqueta-licrada-hombre">Chaqueta licrada hombre</a></li>
                        <li><a href="productos.html?product=esqueleto-licrado-hombre">Esqueleto licrado</a></li>
                        <li><a href="productos.html?product=pantalon-hombre">Pantalones hombre</a></li>
                        <li><a href="productos.html?product=esqueleto-capota-hombre">Esqueleto capota</a></li>
                        <li><a href="productos.html?product=esqueleto-harder-hombre">Esqueleto harder</a></li>
                        <li><a href="productos.html?product=conjunto-oversize-hombre">Conjunto oversize esqueleto hombre</a></li>
                    </ul>
                </li>
                <li class="has-dropdown">
                    <a href="index.html#descuentos-section">Descuentos</a>
                     <ul class="dropdown">
                        <li><a href="productos.html?product=buso-palo-rosa-descuento">Enterizo Licra</a></li>
                        <li><a href="productos.html?product=set-bicolor-descuento">Blusa Polo</a></li>
                        <li><a href="productos.html?product=pantaloneta-unicolor-descuento">Pantaloneta Era</a></li>
                        <li><a href="productos.html?product=leggins-pushup-descuento">Busos Polo</a></li>
                        <li><a href="productos.html?product=leggins-suplex-descuento">Leggins Suplex</a></li>
                        <li><a href="productos.html?product=short-pushup-descuento">Short Push Up</a></li>
                        <li><a href="productos.html?product=leggins-unicolor-descuento">Leggins Unicolor</a></li>
                        <li><a href="productos.html?product=pantalon-sudadera-descuento">Pantalón Sudadero</a></li>
                        <li><a href="productos.html?product=bolso-deportivo-descuento">Bolso Deportivo</a></li>
                     </ul>
                </li>
                <li><a href="index.html#descuentos-section">Promociones</a></li>
            </ul>
        </nav>
       
        <a href="index.html" class="logo">
            <img src="848ac857-7327-47f4-b080-7313d6823a80.png" alt="Logotipo de Sportiva Store" onerror="this.onerror=null;this.src='https://placehold.co/200x100/1a1a1a/f1faee?text=Sportiva';">
        </a>

        <div class="header-right">
             <div class="header-icons">
                <button class="icon-btn" id="search-btn" aria-label="Buscar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
                <button class="icon-btn" id="cart-btn" aria-label="Ver carrito">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                    <span id="cart-counter" class="cart-counter">0</span>
                </button>
             </div>
             <button class="hamburger" aria-label="Abrir menú">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
        </div>
    </header>

    <main class="product-page-container">
        <a href="index.html" class="back-to-shop-link">← Volver a la Tienda</a>
        
        <div class="product-detail-main" id="product-detail-main">
            <!-- El contenido del producto se cargará aquí dinámicamente -->
            <div class="product-detail-loading">
                <h2>Cargando producto...</h2>
            </div>
        </div>

        <div id="combina-con-container"></div>

    </main>

    <footer class="footer">
        <div class="footer-grid">
            <div class="footer-column">
                <h4 class="footer-logo-text">SPORTIVA STORE</h4>
                <p>Diseñamos y fabricamos prendas deportivas y casuales con la mejor calidad para superar tus límites.</p>
                <p>Gracias por confiar en nosotros. #SuperaTusLimites</p>
            </div>
            <div class="footer-column">
                <h4>Categorías</h4>
                <a href="index.html#women-catalog">Tienda</a>
                <a href="index.html#women-catalog">Mujeres</a>
                <a href="index.html#men-catalog">Hombres</a>
                <a href="#descuentos-section">Descuentos</a>
                <a href="#descuentos-section">Promociones</a>
                <a href="#">Términos y Condiciones</a>
            </div>
            <div class="footer-column">
                <h4>Contacto y Redes</h4>
                <a href="mailto:sportivastore2006@gmail.com">sportivastore2006@gmail.com</a>
                <a href="tel:+573223175541">(+57) 322 317 5541</a>
                <div class="footer-social-icons">
                    <a href="https://www.instagram.com/sportiva.store__?igsh=MWh0cXNmYTI5MDZ3Mw==" title="Instagram" target="_blank">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                    </a>
                    <a href="https://www.tiktok.com/@sportiva.store_" title="TikTok" target="_blank">TikTok</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Sportiva Store. Todos los derechos reservados.</p>
        </div>
    </footer>
    
    <a href="https://wa.me/573223175541" class="whatsapp-fab" target="_blank" title="Contactar por WhatsApp">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
            <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
        </svg>
    </a>

    <div id="search-overlay" class="search-overlay"><button id="close-search" class="close-btn">&times;</button><div class="search-content"><input type="text" id="search-input" placeholder="Buscar productos..."></div></div>

    <div id="cart-panel" class="cart-panel">
        <div class="cart-header"><h3>Tu Carrito</h3><button id="close-cart" class="close-btn">&times;</button></div>
        <div id="cart-items" class="cart-items"></div>
        <div class="cart-footer"><div class="cart-total"><span>Total:</span><span id="cart-total-price">$0</span></div><button class="btn checkout-btn">Finalizar Compra</button></div>
    </div>
    
    <!-- Agrega Firebase SDKs aquí -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="products-db.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productDetailContainer = document.getElementById('product-detail-main');
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('product');

            // La función initializeProducts() de script.js ya debería haber sido llamada
            if (typeof siteProducts === 'undefined' || Object.keys(siteProducts).length === 0) {
                 initializeProducts(); // Llamada de respaldo por si acaso
            }

            const product = siteProducts[productId];

            if (!product) {
                productDetailContainer.innerHTML = `<div class="product-not-found"><h2>Lo sentimos, producto no encontrado.</h2><a href="index.html" class="btn">Volver a la tienda</a></div>`;
                return;
            }
            
            // El título de la página se actualizará desde Firestore a través de script.js
            // document.title = `${product.name} - Sportiva Store`;

            // --- Lógica para renderizar el producto ---
            const renderProduct = () => {
                // Find the initial model/color based on the first entry
                let selectedColor = product.colors ? product.colors[0] : null;
                let selectedModel = product.models ? product.models[0] : null;

                // Determine the initial price to display
                let initialPrice = product.unitPrice || (selectedModel ? selectedModel.price : 0);

                let priceHTML = '';
                if (product.category === 'discount' && product.wholesalePrice && product.wholesalePrice < product.unitPrice) {
                    const discount = Math.round((1 - (product.wholesalePrice / product.unitPrice)) * 100);
                    priceHTML = `<span class="old-price">${formatCurrency(product.unitPrice)}</span><span class="current-price">${formatCurrency(product.wholesalePrice)}</span><span class="save-badge">AHORRA ${discount}%</span>`;
                    initialPrice = product.wholesalePrice;
                } else {
                    priceHTML = `<span class="current-price single-price">${formatCurrency(initialPrice)}</span>`;
                }
                
                const initialImage = selectedColor ? selectedColor.image : (selectedModel ? selectedModel.image : 'placeholder.jpg');

                // Build the main product detail HTML
                productDetailContainer.innerHTML = `
                    <div class="product-detail-image-wrapper">
                        <img src="${initialImage}" alt="${product.name}" id="product-detail-image" onerror="this.onerror=null;this.src='https://placehold.co/600x800/f0f0f0/333?text=${encodeURIComponent(product.name)}';">
                    </div>
                    <div class="product-detail-info">
                        <h1 class="product-detail-title">${product.name}</h1>
                        <div class="product-pricing-new" id="product-price-display">${priceHTML}</div>
                        <div id="out-of-stock-container"></div>
                        
                        <div class="product-colors-new">
                            <p class="product-options-label">COLOR: <span id="selected-color-name">${(selectedColor && selectedColor.name) || (selectedModel && selectedModel.name) || ''}</span></p>
                            <div class="color-palette-new" id="color-palette-container"></div>
                        </div>

                        <div id="size-selector-container"></div>

                        <div class="product-actions">
                            <div class="quantity-selector">
                                <button class="quantity-btn" data-action="decrease">-</button>
                                <input type="number" id="quantity-input" value="1" min="1" max="10" readonly>
                                <button class="quantity-btn" data-action="increase">+</button>
                            </div>
                            <button class="btn-add-to-cart-new" id="add-to-cart-btn">Agregar al Carrito</button>
                        </div>
                        <div class="product-description-section"><p><strong>Descripción:</strong> ${product.description}</p></div>
                        <div class="product-accordion">
                            <div class="accordion-item"><button class="accordion-header">Sostenibilidad<span class="accordion-icon">+</span></button><div class="accordion-content"><p>${product.sustainability || 'Info no disponible.'}</p></div></div>
                            <div class="accordion-item"><button class="accordion-header">Cuidado del Producto<span class="accordion-icon">+</span></button><div class="accordion-content"><p>${product.productCare || 'Info no disponible.'}</p></div></div>
                        </div>
                    </div>`;

                const addToCartBtn = document.getElementById('add-to-cart-btn');
                const priceDisplay = document.getElementById('product-price-display');

                // Renderizar selector de tallas si el producto tiene la propiedad 'sizes'
                if (product.sizes) {
                    const sizeContainer = document.getElementById('size-selector-container');
                    const sizeOrder = ['XS', 'S', 'M', 'L'];
                    let sizeSelectorHTML = `
                        <div class="product-sizes-new">
                            <p class="product-options-label">TALLA:</p>
                            <div class="size-selector-new" id="size-selector">`;
                    
                    sizeOrder.forEach(size => {
                        if (product.sizes[size]) {
                            const stock = product.sizes[size].stock;
                            const isSpecialOrder = stock === -1; // -1 indica "por encargo"
                            const isDisabled = stock === 0 && !isSpecialOrder;
                            
                            sizeSelectorHTML += `
                                <div class="size-option-new">
                                    <input type="radio" id="size-${size}" name="product-size" value="${size}" ${isDisabled ? 'disabled' : ''}>
                                    <label for="size-${size}">
                                        ${size}
                                        ${isSpecialOrder ? '<span class="special-order-text-shop">(por encargo)</span>' : ''}
                                    </label>
                                </div>`;
                        }
                    });
                    sizeSelectorHTML += `</div></div>`;
                    sizeContainer.innerHTML = sizeSelectorHTML;
                }

                // Function to update the stock status and button state
                const updateStockStatus = () => {
                    const outOfStockContainer = document.getElementById('out-of-stock-container');
                    const quantitySelector = document.querySelector('.quantity-selector');
                    const hasSizes = !!product.sizes;

                    // If product has sizes and total stock is 0, it's out of stock
                    let isOutOfStock = false;
                    if (hasSizes) {
                        const totalStock = Object.values(product.sizes).reduce((sum, size) => sum + Math.max(0, size.stock), 0);
                        isOutOfStock = totalStock === 0;
                    }

                    if (isOutOfStock) {
                        outOfStockContainer.innerHTML = `<div class="out-of-stock-message">Producto Agotado</div>`;
                        addToCartBtn.disabled = true;
                        if (quantitySelector) {
                            quantitySelector.style.display = 'none';
                        }
                    } else {
                        outOfStockContainer.innerHTML = '';
                        addToCartBtn.disabled = false;
                        if (quantitySelector) {
                            quantitySelector.style.display = 'flex';
                        }
                    }
                };

                updateStockStatus();

                // Lógica de selectores de color/modelo
                const paletteContainer = document.getElementById('color-palette-container');
                const productImage = document.getElementById('product-detail-image');
                const selectedColorName = document.getElementById('selected-color-name');

                const variants = product.colors || product.models;
                if (variants) {
                    variants.forEach((variant, index) => {
                        const swatch = document.createElement('span');
                        swatch.className = 'color-swatch-new';
                        swatch.style.backgroundColor = variant.hex || '#ccc'; // Usa hex si está disponible, o un color por defecto
                        if (index === 0) swatch.classList.add('active');
                        
                        swatch.addEventListener('click', () => {
                            const currentSelected = product.colors ? selectedColor : selectedModel;
                            if (currentSelected && currentSelected.name === variant.name) return;

                            if (product.colors) {
                                selectedColor = variant;
                            } else if (product.models) {
                                selectedModel = variant;
                                // Actualiza la visualización del precio para los modelos
                                const newPrice = selectedModel.price || 0;
                                priceDisplay.innerHTML = `<span class="current-price single-price">${formatCurrency(newPrice)}</span>`;
                            }
                            
                            selectedColorName.textContent = variant.name;
                            
                            productImage.classList.add('image-fade-out');
                            setTimeout(() => {
                                productImage.src = variant.image;
                                productImage.alt = `${product.name} - ${variant.name}`;
                                productImage.onerror = () => { productImage.src = `https://placehold.co/600x800/f0f0f0/333?text=${encodeURIComponent(variant.name)}`; };
                                productImage.classList.remove('image-fade-out');
                            }, 400);

                            document.querySelector('.color-swatch-new.active').classList.remove('active');
                            swatch.classList.add('active');
                        });
                        paletteContainer.appendChild(swatch);
                    });
                }
                
                // Lógica del botón "Agregar al Carrito"
                addToCartBtn.addEventListener('click', () => {
                    let selectedSize = null;
                    if (product.sizes) {
                        const checkedSizeInput = document.querySelector('input[name="product-size"]:checked');
                        if (!checkedSizeInput) {
                            alert('Por favor, selecciona una talla.');
                            return;
                        }
                        selectedSize = checkedSizeInput.value;
                    }

                    // Determina los detalles del artículo basándose en el tipo de producto (colección, estándar)
                    let finalProduct = product;
                    if (finalProduct.models) {
                        finalProduct = selectedModel; // Si es una colección con modelos, usa el modelo seleccionado
                    } else {
                        finalProduct = selectedColor; // Si es un producto con colores, usa el color seleccionado
                    }
                    
                    const cartId = `${finalProduct.id}` + (selectedSize ? `-${selectedSize}` : '');
                    const cartName = `${product.name}` + (finalProduct.name ? ` - ${finalProduct.name}` : '') + (selectedSize ? ` (Talla: ${selectedSize})` : '');
                    const cartImage = finalProduct.image;
                    const quantity = parseInt(document.getElementById('quantity-input').value);
                    // El precio a usar debe ser el del producto principal si no es una colección,
                    // o el del modelo/color seleccionado si lo es.
                    let priceToUse = product.wholesalePrice || product.unitPrice || finalProduct.price;

                    if (quantity <= 0) return;

                    addToCart(cartId, cartName, priceToUse, cartImage, quantity, selectedSize);
                    document.getElementById('cart-panel').classList.add('active');
                });
            };

            renderProduct(); // Llama a renderProduct después de que el DOM esté listo

            // Lógica general (cantidad, acordeón) que se aplica después de renderizar
            const quantityInput = document.getElementById('quantity-input');
            if(quantityInput) {
                document.querySelector('.quantity-selector').addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    let currentValue = parseInt(quantityInput.value);
                    if (action === 'increase' && currentValue < 10) {
                        quantityInput.value = currentValue + 1;
                    } else if (action === 'decrease' && currentValue > 1) {
                        quantityInput.value = currentValue - 1;
                    }
                });
            }

            document.querySelectorAll('.accordion-header').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const item = button.parentElement;
                    item.classList.toggle('active');
                    content.style.maxHeight = item.classList.contains('active') ? content.scrollHeight + "px" : null;
                });
            });
        });
    </script>
</body>
</html>
